/*
* Copyright 2019 Seven Spikes Ltd. All rights reserved. (http://www.nop-templates.com)
* http://www.nop-templates.com/t/licensinginfo
*/

!function(s,m,g){function e(){var e=g.getHiddenValFromDom("#create-condition-group-url"),t=g.getHiddenValFromDom("#condition-id");if(""!==e&&""!==t){var o={conditionId:t};addAntiForgeryToken(o),s.ajax({cache:!1,type:"POST",data:o,url:e,success:function(e){i(e),r(e)},error:function(){alert("Creating new condition group failed.")}})}}function t(){var e=g.getHiddenValFromDom("#delete-condition-group-url"),t=s(this).closest(".condition-group-grid"),o=s(t).attr("id"),n=s(t).attr("data-conditionGroupId");if(""!==e&&n&&o){var i={conditionGroupId:n};addAntiForgeryToken(i),s.ajax({cache:!1,type:"POST",data:i,url:e,success:function(){s("#"+o).data("kendoGrid").destroy(),s("#"+o).parent(".condition-group-wrapper").remove()},error:function(){alert("Deleting condition group failed.")}})}}function o(){var e=g.getHiddenValFromDom("#update-condition-url"),t=g.getHiddenValFromDom("#condition-id"),o=g.getHiddenValFromDom("#condition #ConditionName"),n=g.getHiddenValFromDom("#condition #DefaultConditionValue"),i={ConditionName:o,Active:!!s("#condition #Active").attr("checked"),DefaultConditionValue:n,conditionId:t};addAntiForgeryToken(i),s.ajax({cache:!1,type:"POST",data:i,url:e,error:function(){alert("Updating condition failed.")}})}function n(){var e=g.getHiddenValFromDom("#update-default-condition-group-statement-url"),t={conditionId:g.getHiddenValFromDom("#condition-id"),defaultConditionStatementValue:s("#condition #DefaultConditionValue").find(":selected").val()};addAntiForgeryToken(t),s.ajax({cache:!1,type:"POST",data:t,url:e,error:function(){alert("Updating condition default group statement failed.")}})}function i(e){var t='<div class="condition-group-wrapper"><div class="condition-group-grid" id="'+("condition-group-grid-"+e)+'" data-conditionGroupId="'+e+'"></div><div class="group-dependancy-text"><p>--OR--</p></div></div>';s("#condition-groups-wrapper").append(t)}function r(i){var e="condition-group-grid-"+i,t=g.getHiddenValFromDom("#read-condition-group-url"),o=g.getHiddenValFromDom("#update-condition-statement-url"),n=g.getHiddenValFromDom("#destroy-condition-statement-url"),r=g.getHiddenValFromDom("#create-condition-statement-url"),a=new m.data.DataSource({transport:{type:"json",read:{url:t,cache:!1,dataType:"json",data:addAntiForgeryToken},update:{url:o,type:"POST",dataType:"json",data:addAntiForgeryToken},destroy:{url:n,cache:!1,dataType:"json",data:addAntiForgeryToken},create:{url:r,type:"POST",dataType:"json",data:addAntiForgeryToken},parameterMap:function(e,t){if("read"===t)return addAntiForgeryToken({conditionGroupId:i});if("destroy"===t)return addAntiForgeryToken({conditionStatementId:e.ConditionStatementId});if("update"===t||"create"===t){var o=s("#condition-property-value").val(),n={conditionGroupId:i,id:e.ConditionStatementId,conditionTypeId:e.ConditionType.Id,conditionPropertyValue:e.ConditionProperty.Id,operatorTypeValue:e.ConditionPropertyOperator.Id,value:o};return addAntiForgeryToken(n)}return JSON.stringify(e)}},schema:{data:"Data",total:"Total",errors:"Errors",model:{id:"Id",fields:{Id:{type:"number",editable:!1},ConditionType:{defaultValue:{Id:0,Name:"Select type..."}},ConditionProperty:{defaultValue:{Id:0,Name:"Select property..."}},ConditionPropertyOperator:{defaultValue:{Id:0,Name:"Select operator..."}},ConditionPropertyValue:{defaultValue:{Id:0,Name:"Select value..."}}}}},requestEnd:function(e){"create"!==e.type&&"update"!==e.type||this.read()},error:function(e){display_kendoui_grid_error(e),this.cancelChanges()},pageSize:g.getHiddenValFromDom("#defaultGridPageSize")});s("#"+e).kendoGrid({dataSource:a,pageable:{refresh:!0,pageSizes:g.getHiddenValFromDom("#gridPageSizes").split(",")},sortable:!0,editable:{mode:"popup",template:m.template(s("#popup_editor").html()),window:{animation:!1,width:400}},edit:function(e){!function(t){var e=g.getHiddenValFromDom("#get-condition-type-url"),o=g.getHiddenValFromDom("#available-condition-types"),n=JSON.parse(o),i=Object.keys(n),r=s("#condition-type").kendoDropDownList({optionLabel:"Select type...",dataValueField:"Id",dataTextField:"Name",dataSource:{type:"json",transport:{read:{url:e,type:"POST",dataType:"json",data:addAntiForgeryToken({conditionTypeIds:i})}}},change:c}).data("kendoDropDownList"),a=g.getHiddenValFromDom("#get-condition-properties-url"),d=s("#condition-property").kendoDropDownList({optionLabel:"Select property...",autoBind:!1,cascadeFrom:"condition-type",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:a,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(e.conditionPropertyIds=n[r.value()],JSON.stringify(e))}}},change:function(){var e=s("#condition-property-value").getKendoDropDownList(),t=s("#condition-property-value").getKendoComboBox(),o=s("#condition-property-value").getKendoNumericTextBox();e?e.value(""):t?t.value(""):o?o.value(""):s("#condition-property-value").val("")}}).data("kendoDropDownList"),p=g.getHiddenValFromDom("#get-condition-property-operators-url"),l=(s("#condition-property-operator").kendoDropDownList({optionLabel:"Select operator...",autoBind:!1,cascadeFrom:"condition-property",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:p,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}}}).data("kendoDropDownList"),g.getHiddenValFromDom("#get-condition-property-value-type-url"));function u(e){e.filter||(e.filter={}),e.filter.filters||(e.filter.filters=[]),e.filter.filters.unshift({field:"condition-property",operator:"eq",value:parseInt(d.value())}),e.filter.filters.unshift({field:"condition-type",operator:"eq",value:parseInt(r.value())})}function c(){var e=s("#condition-property-value").getKendoDropDownList(),t=s("#condition-property-value").getKendoComboBox(),o=s("#condition-property-value").getKendoNumericTextBox();e?(e.destroy(),e.wrapper.remove()):t?(t.destroy(),t.wrapper.remove()):o&&(o.destroy(),o.wrapper.remove()),s("#condition-property-value").remove()}function y(){var e=g.getHiddenValFromDom("#get-condition-property-values-url"),t=new m.data.DataSource({serverFiltering:!0,type:"json",transport:{read:{url:e,type:"POST",dataType:"json",contentType:"application/json"},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}});return t}s("#condition-property-value-type").kendoDropDownList({autoBind:!1,cascadeFrom:"condition-property",dataValueField:"Id",dataTextField:"Name",dataSource:{serverFiltering:!0,type:"json",transport:{read:{url:l,type:"POST",dataType:"json",contentType:"application/json",complete:function(){var e=s("#condition-property-value-type").data("kendoDropDownList").value();!function(e){c(),s("<input />").attr({type:"text",id:"condition-property-value",name:"Value",required:"required",style:"width: 230px"}).appendTo("#condition-property-value-container"),t.isNew()||s("#condition-property-value").val(t.ConditionPropertyValue.Id);"1"===e?s("#condition-property-value").kendoComboBox({autoBind:!t.isNew(),placeholder:"Select value...",filter:"contains",dataValueField:"Id",dataTextField:"Name",delay:500,change:function(e){var t=e.sender;t.value()&&-1===t.selectedIndex&&(alert("Invalid Entry!"),t.value(""))},dataSource:y()}):"2"===e?s("#condition-property-value").kendoDropDownList({autoBind:!t.isNew(),optionLabel:"Select value...",dataValueField:"Id",dataTextField:"Name",dataSource:y()}):"3"===e&&s("#condition-property-value").kendoNumericTextBox()}(e)}},parameterMap:function(e,t){return"read"!==t?e:(u(e),JSON.stringify(e))}}}}).data("kendoDropDownList").wrapper.hide()}(e.model)},save:function(e){e.model.isNew()||(e.model.dirty=!0)},cancel:function(){this.cancelChanges()},toolbar:["create","destroy"],columns:[{field:"ConditionType",title:"Type",width:100,template:"#: ConditionType ? ConditionType.Name : null #"},{field:"ConditionProperty",title:"Property",width:100,template:"#: ConditionProperty ? ConditionProperty.Name : null #"},{field:"ConditionPropertyOperator",title:"Operator",width:100,template:"#: ConditionPropertyOperator ? ConditionPropertyOperator.Name : null #"},{field:"ConditionPropertyValue",title:"Value",width:100,template:"#: ConditionPropertyValue ? ConditionPropertyValue.Name : null #"},{command:["edit","destroy"],title:"&nbsp;",width:"150px"}]})}s(document).ready(function(){!function(){var e=s.parseJSON(g.getHiddenValFromDom("#condition-groups"));if(null!=e)for(var t=0;t<e.length;t++)i(e[t]),r(e[t])}(),s(document).on("click","a.add-condition-group",e),s(document).on("click",".k-grid-toolbar a.k-grid-delete",t),s(document).on("change","#condition #ConditionName, #condition #Active",o),s(document).on("change","#condition #DefaultConditionValue",n)})}(jQuery,kendo,sevenSpikesCore);