@model int
@inject IPictureService pictureService
@inject MediaSettings mediaSettings

@using System.Text.Json
@using Nop.Core.Domain.Media
@using Nop.Services.Media

@{
    // Identifiers
    var random = CommonHelper.GenerateRandomInteger();
    var clientId = $"picture{random}";
    var elementId = $"{clientId}element";
    var imageId = $"{clientId}image";
    
    // Constants
    const int pictureSize = 100;
    var allowedMimeTypes = new List<string> { MimeTypes.ImagePng, MimeTypes.ImageBmp, MimeTypes.ImageGif, MimeTypes.ImageJpeg, MimeTypes.ImagePJpeg, MimeTypes.ImageTiff, MimeTypes.ImageWebp };

    if (mediaSettings.AllowSvgUploads)
        allowedMimeTypes.Add(MimeTypes.ImageSvg);

    var picture = await pictureService.GetPictureByIdAsync(Model);
    var files = new List<object>();

    if (picture != null)
    {
        var pictureSource = $"{picture.SeoFilename}.{await pictureService.GetFileExtensionFromMimeTypeAsync(picture.MimeType)}";
        files.Add(new
        {
            source = pictureSource,
            options = new
            {
                type = "local",
                file = new
                {
                    name = pictureSource,
                    size = (await pictureService.GetPictureBinaryByPictureIdAsync(picture.Id))?.BinaryData?.Length,
                    type = picture.MimeType
                },
                metadata = new
                {
                    url = await pictureService.GetPictureUrlAsync(Model, showDefaultPicture: false)
                }
            },
        });
    }

    var jsonModel = new
    {
        modelId = Html.IdForModel(),
        clientId = clientId,
        elementId = elementId,
        imageId = imageId,
        defaultPictureUrl = await pictureService.GetDefaultPictureUrlAsync(pictureSize),
        currentPictureUrl = await pictureService.GetPictureUrlAsync(Model, pictureSize),
        commonError = T("Common.Error"),
        imageProcessUrl = Url.Content("~/Admin/Picture/AsyncUpload"),
        filePondProps = new
        {
            acceptedFileTypes = allowedMimeTypes,
            files,
            labelIdle = $"{T("Common.FileUploader.DropFiles")} / <span class=\"filepond--label-action\"> {T("Common.FileUploader.Browse")}</span>",
            labelFileProcessing = T("Common.FileUploader.Processing"),
        }
    };
}

<noscript>
    <p>Please enable JavaScript to use file uploader.</p>
</noscript>
<input type="hidden" asp-for="@Model"/>

<div id="@(jsonModel.elementId)" class="filepond"></div>
<div class="upload-picture-block">
    <div class="picture-container">
        <div class="uploaded-image">
            <img id="@(jsonModel.imageId)" src="@jsonModel.currentPictureUrl" width="@(pictureSize)"/>
        </div>
    </div>
</div>

@* register CSS and JS *@
<link rel="stylesheet" href="~/lib_npm/filepond/filepond.min.css"/>
<link rel="stylesheet" href="~/lib_npm/filepond-plugin-get-file/filepond-plugin-get-file.min.css"/>
<script asp-exclude-from-bundle="true" src="~/lib_npm/filepond/filepond.min.js" asp-location="Footer"></script>
<script asp-exclude-from-bundle="true"
        src="~/lib_npm/filepond-plugin-file-validate-type/filepond-plugin-file-validate-type.min.js"
        asp-location="Footer"></script>
<script asp-exclude-from-bundle="true" src="~/lib_npm/filepond-plugin-get-file/filepond-plugin-get-file.min.js"
        asp-location="Footer"></script>

<script asp-location="Footer">

    $(async function () {

        // Register the plugins
        FilePond.registerPlugin(FilePondPluginFileValidateType, FilePondPluginGetFile);
        const model = @Html.Raw(Json.Serialize(jsonModel));
        
        const $modelEl = $(`#${model.modelId}`);
        const $imageEl = $(`#${model.imageId}`);
        const $removeEl = $(`#${model.clientId}`);

        function resetImageToDefault() {
            $modelEl.val('0');
            $imageEl.attr("src", model.defaultPictureUrl);
        }

        const serverConfig = {
            process: (fieldName, file, metadata, load, error, progress, abort, transfer, options) => {
                const formData = new FormData();
                formData.append(fieldName, file, file.name);

                const request = new XMLHttpRequest();
                request.open('POST', model.imageProcessUrl);

                request.upload.onprogress = (e) => {
                    progress(e.lengthComputable, e.loaded, e.total);
                };

                request.onload = function () {
                    const commonError = model.commonError;
                    if (request.status < 200 || request.status >= 300) {
                        error(commonError);
                        return;
                    }

                    const response = JSON.parse(request.responseText);

                    if (response.success) {
                        load(request.responseText);
                        $imageEl.attr("src", response.imageUrl);
                        $modelEl.val(response.pictureId);
                    } else {
                        error(response.message || commonError);
                    }
                };

                request.send(formData);
            },
            remove: (source, load, error) => {
                resetImageToDefault();
                load();
            },
            revert: (uniqueFileId, load, error) => {
                resetImageToDefault();
                load();
            },
        };

        // Create a FilePond instance
        const filePondInstance = FilePond.create(document.querySelector(`#${model.elementId}`), {
            credits: false,
            allowMultiple: false,
            maxFiles: 1,
            allowDownloadByUrl: true,
            server: serverConfig,
            labelFileProcessingError: (err) => err.body,
            ...model.filePondProps,
        });

        $removeEl.on('click', function (e) {
            resetImageToDefault();
            filePondInstance.removeFiles();
            $(this).hide();
        });
    });
</script>